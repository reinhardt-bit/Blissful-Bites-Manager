// cmd/main.go
package main

import (
	"blissfulBytes-management/internal"
	"blissfulBytes-management/shared/db"
	"database/sql"
	"fmt"
	"log"
	"strconv"
	"time"

	"fyne.io/fyne/v2"
	"fyne.io/fyne/v2/app"
	"fyne.io/fyne/v2/container"
	"fyne.io/fyne/v2/dialog"
	"fyne.io/fyne/v2/widget"

	"github.com/xuri/excelize/v2"
)

func main() {
	db, err := db.InitDB()
	if err != nil {
		log.Fatal(err)
	}
	defer db.Close()

	myApp := app.New()
	myWindow := myApp.NewWindow("Blissful Bites Order Management")

	// Create menu items
	mainMenu := fyne.NewMainMenu(
		fyne.NewMenu("Products",
			fyne.NewMenuItem("Add New Product", func() {
				showAddProductDialog(myWindow, db)
			}),
			fyne.NewMenuItem("Manage Products", func() {
				showManageProductsDialog(myWindow, db)
			}),
		),
		fyne.NewMenu("Representatives",
			fyne.NewMenuItem("Add New Representative", func() {
				showAddRepresentativeDialog(myWindow, db)
			}),
			fyne.NewMenuItem("Manage Representatives", func() {
				showManageRepresentativesDialog(myWindow, db)
			}),
		),
	)
	myWindow.SetMainMenu(mainMenu)

	// Initialize order table
	orderTable := widget.NewTable(
		func() (int, int) { return 6, 5 },
		func() fyne.CanvasObject {
			return widget.NewLabelWithStyle("", fyne.TextAlignLeading, fyne.TextStyle{})
		},
		func(id widget.TableCellID, cell fyne.CanvasObject) {},
	)

	// Refresh function for the order table
	refreshTable := func() {
		orders, err := internal.LoadOrders(db)
		if err != nil {
			log.Printf("Error loading orders: %v", err)
			return
		}

		orderTable.Length = func() (int, int) {
			return len(orders) + 1, 5 // +1 for header row
		}

		orderTable.UpdateCell = func(id widget.TableCellID, cell fyne.CanvasObject) {
			orderTable.SetColumnWidth(0, 150) // Date
			orderTable.SetColumnWidth(1, 200) // Client
			orderTable.SetColumnWidth(2, 300) // Product
			orderTable.SetColumnWidth(3, 100) // Price
			orderTable.SetColumnWidth(4, 150) // Representative
			orderTable.SetColumnWidth(5, 50)  // Status

			label := cell.(*widget.Label)
			if id.Row == 0 {
				// Header row
				switch id.Col {
				case 0:
					label.SetText("Date")
				case 1:
					label.SetText("Client")
				case 2:
					label.SetText("Product")
				case 3:
					label.SetText("Total")
				case 4:
					label.SetText("Representative")
				case 5:
					label.SetText("Status")
				}
				return
			}

			order := orders[id.Row-1]
			switch id.Col {
			case 0:
				label.SetText(order.CreatedAt.Format("2006-01-02 15:04"))
			case 1:
				label.SetText(order.ClientName)
			case 2:
				label.SetText(fmt.Sprintf("%d x %s", order.Quantity, order.ProductName))
			case 3:
				label.SetText(fmt.Sprintf("R%.2f", order.Price))
			case 4:
				label.SetText(order.RepresentativeName)
			case 5:
				if order.Completed {
					label.SetText("Completed")
				} else {
					label.SetText("Pending")
				}
			}
		}
		orderTable.Refresh()
	}

	// Add new order button
	addOrderBtn := widget.NewButton("+", func() {
		showAddOrderDialog(myWindow, db, refreshTable)
	})

	// Create the layout
	form := container.NewVBox(
		widget.NewLabel("Orders"),
		addOrderBtn,
	)

	// Track selected row
	var selectedRow int = -1
	orderTable.OnSelected = func(id widget.TableCellID) {
		selectedRow = id.Row
	}

	// Complete order button
	completeBtn := widget.NewButton("Mark Selected as Completed", func() {
		if selectedRow > 0 {
			orders, _ := internal.LoadOrders(db)
			orderID := orders[selectedRow-1].ID

			_, err := db.Exec("UPDATE orders SET completed = true WHERE id = ?", orderID)
			if err != nil {
				log.Printf("Error completing order: %v", err)
				return
			}
			refreshTable()
		}
	})

	downloadOrdersBtn := widget.NewButton("Download Orders", func() {
		err := exportTableToExcel(db, "orders", "orders-history.xlsx")
		if err != nil {
			log.Printf("Error exporting to Excel: %v", err)
		} else {
			fmt.Println("Data exported successfully to orders-history.xlsx")
		}
	})

	split := container.NewHSplit(
		form,
		container.NewBorder(
			nil,
			container.NewHBox(
				completeBtn,
				downloadOrdersBtn,
			),
			// completeBtn,
			nil,
			nil,
			orderTable,
		),
	)
	split.SetOffset(0.03)

	myWindow.SetContent(split)
	myWindow.Resize(fyne.NewSize(1024, 768))

	// Initial table load
	refreshTable()

	myWindow.ShowAndRun()
}

func showAddProductDialog(window fyne.Window, db *sql.DB) {
	nameEntry := widget.NewEntry()
	nameEntry.SetPlaceHolder("Product Name")

	priceEntry := widget.NewEntry()
	priceEntry.SetPlaceHolder("Price")

	content := container.NewVBox(
		nameEntry,
		priceEntry,
	)

	dialog := dialog.NewCustomConfirm(
		"Add New Product",
		"Add",
		"Cancel",
		content,
		func(submit bool) {
			if !submit {
				return
			}

			price, err := strconv.ParseFloat(priceEntry.Text, 64)
			if err != nil {
				dialog.ShowError(fmt.Errorf("Invalid price"), window)
				return
			}

			_, err = db.Exec("INSERT INTO products (name, price, active) VALUES (?, ?, true)",
				nameEntry.Text, price)
			if err != nil {
				dialog.ShowError(err, window)
				return
			}

			dialog.ShowInformation("Success", "Product added successfully", window)
		},
		window,
	)

	dialog.Show()
}

func showManageProductsDialog(window fyne.Window, db *sql.DB) {
	products, err := internal.LoadProducts(db)
	if err != nil {
		dialog.ShowError(err, window)
		return
	}

	list := widget.NewTable(
		func() (int, int) {
			return len(products), 1
		},
		func() fyne.CanvasObject {
			return container.NewHBox(
				widget.NewLabel("Template"),
				widget.NewButton("Edit", func() {}),
				widget.NewButton("Deactivate", func() {}),
			)
		},
		func(id widget.TableCellID, cell fyne.CanvasObject) {
			box := cell.(*fyne.Container)
			label := box.Objects[0].(*widget.Label)
			editBtn := box.Objects[1].(*widget.Button)
			deactivateBtn := box.Objects[2].(*widget.Button)

			product := products[id.Row]
			label.SetText(fmt.Sprintf("%s - R%.2f", product.Name, product.Price))

			editBtn.OnTapped = func() {
				showEditProductDialog(window, db, product)
			}

			deactivateBtn.OnTapped = func() {
				dialog.ShowConfirm("Deactivate Product",
					"Are you sure you want to deactivate this product? It will no longer be available for new orders.",
					func(confirm bool) {
						if confirm {
							_, err := db.Exec("UPDATE products SET active = false WHERE id = ?", product.ID)
							if err != nil {
								dialog.ShowError(err, window)
								return
							}
							showManageProductsDialog(window, db)
						}
					},
					window,
				)
			}
		},
	)

	list.SetColumnWidth(0, 500)

	content := container.NewVScroll(list)
	content.Resize(fyne.NewSize(600, 400))

	dialog := dialog.NewCustom("Manage Products", "Close", content, window)
	dialog.Resize(fyne.NewSize(600, 400))
	dialog.Show()
}

func showEditProductDialog(window fyne.Window, db *sql.DB, product internal.Product) {
	nameEntry := widget.NewEntry()
	nameEntry.SetText(product.Name)

	priceEntry := widget.NewEntry()
	priceEntry.SetText(fmt.Sprintf("%.2f", product.Price))

	content := container.NewVBox(
		nameEntry,
		priceEntry,
	)

	dialog := dialog.NewCustomConfirm(
		"Edit Product",
		"Save",
		"Cancel",
		content,
		func(submit bool) {
			if !submit {
				return
			}

			price, err := strconv.ParseFloat(priceEntry.Text, 64)
			if err != nil {
				dialog.ShowError(fmt.Errorf("Invalid price"), window)
				return
			}

			_, err = db.Exec("UPDATE products SET name = ?, price = ? WHERE id = ?",
				nameEntry.Text, price, product.ID)
			if err != nil {
				dialog.ShowError(err, window)
				return
			}

			showManageProductsDialog(window, db)
		},
		window,
	)
	dialog.Resize(fyne.NewSize(400, 400))
	dialog.Show()
}

func showAddOrderDialog(window fyne.Window, db *sql.DB, refreshTable func()) {
	products, err := internal.LoadProducts(db)
	if err != nil {
		dialog.ShowError(err, window)
		return
	}

	var productNames []string
	for _, p := range products {
		productNames = append(productNames, p.Name)
	}

	nameEntry := widget.NewEntry()
	nameEntry.SetPlaceHolder("Client Name")

	contactEntry := widget.NewEntry()
	contactEntry.SetPlaceHolder("Contact")

	productSelect := widget.NewSelect(productNames, nil)
	productSelect.PlaceHolder = "Select product"

	quantityEntry := widget.NewEntry()
	quantityEntry.SetPlaceHolder("Quantity")

	priceLabel := widget.NewLabel("Price: R0.00")
	var selectedProduct internal.Product

	productSelect.OnChanged = func(value string) {
		for _, p := range products {
			if p.Name == value {
				selectedProduct = p
				priceLabel.SetText(fmt.Sprintf("Price: R%.2f", p.Price))
				break
			}
		}
	}

	deliveryCheck := widget.NewCheck("Needs Delivery", nil)

	addressEntry := widget.NewMultiLineEntry()
	addressEntry.SetPlaceHolder("Delivery Address")

	commentEntry := widget.NewMultiLineEntry()
	commentEntry.SetPlaceHolder("Comment")

	representatives, err := internal.LoadRepresentatives(db)
	if err != nil {
		dialog.ShowError(err, window)
		return
	}

	var repNames []string
	for _, r := range representatives {
		repNames = append(repNames, r.Name)
	}

	repSelect := widget.NewSelect(repNames, nil)
	repSelect.PlaceHolder = "Select rep"

	content := container.NewVBox(
		repSelect,
		nameEntry,
		contactEntry,
		productSelect,
		quantityEntry,
		priceLabel,
		deliveryCheck,
		addressEntry,
		commentEntry,
	)

	dialog := dialog.NewCustomConfirm(
		"Add New Order",
		"Add",
		"Cancel",
		content,
		func(submit bool) {
			if !submit {
				return
			}

			// Find selected representative ID
			var repID int64
			for _, r := range representatives {
				if r.Name == repSelect.Selected {
					repID = r.ID
					break
				}
			}

			quantity, err := strconv.Atoi(quantityEntry.Text)
			if err != nil {
				dialog.ShowError(fmt.Errorf("Invalid quantity"), window)
				return
			}

			totalPrice := selectedProduct.Price * float64(quantity)

			_, err = db.Exec(`
                INSERT INTO orders (
                    created_at, client_name, contact, product_id,
                    representative_id, quantity, price, needs_delivery,
                    delivery_address, comment, completed
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
				time.Now(), nameEntry.Text, contactEntry.Text,
				selectedProduct.ID, repID, quantity, totalPrice,
				deliveryCheck.Checked, addressEntry.Text,
				commentEntry.Text, false,
			)

			if err != nil {
				dialog.ShowError(err, window)
				return
			}

			refreshTable()
		},
		window,
	)

	dialog.Resize(fyne.NewSize(600, 500))
	dialog.Show()
}

func exportTableToExcel(db *sql.DB, tableName, fileName string) error {
	// Query the table
	rows, err := db.Query(fmt.Sprintf("SELECT * FROM %s", tableName))
	if err != nil {
		return fmt.Errorf("error querying table: %w", err)
	}
	defer rows.Close()

	// Get column names
	columns, err := rows.Columns()
	if err != nil {
		return fmt.Errorf("error fetching column names: %w", err)
	}

	// Create a new Excel file
	f := excelize.NewFile()
	sheetName := "Sheet1"
	f.SetSheetName("Sheet1", sheetName)

	// Write column headers
	for i, col := range columns {
		columnName, _ := excelize.ColumnNumberToName(i + 1)
		cell := columnName + "1"
		f.SetCellValue(sheetName, cell, col)
	}

	// Write rows
	rowIndex := 2
	for rows.Next() {
		values := make([]interface{}, len(columns))
		valuePtrs := make([]interface{}, len(columns))
		for i := range values {
			valuePtrs[i] = &values[i]
		}

		if err := rows.Scan(valuePtrs...); err != nil {
			return fmt.Errorf("error scanning row: %w", err)
		}

		for i, val := range values {
			columnName, _ := excelize.ColumnNumberToName(i + 1)
			cell := columnName + fmt.Sprintf("%d", rowIndex)
			f.SetCellValue(sheetName, cell, val)
		}
		rowIndex++
	}

	// Save the Excel file
	if err := f.SaveAs(fileName); err != nil {
		return fmt.Errorf("error saving Excel file: %w", err)
	}

	return nil
}

func showAddRepresentativeDialog(window fyne.Window, db *sql.DB) {
	nameEntry := widget.NewEntry()
	nameEntry.SetPlaceHolder("Representative Name")

	content := container.NewVBox(nameEntry)

	dialog := dialog.NewCustomConfirm(
		"Add New Representative",
		"Add",
		"Cancel",
		content,
		func(submit bool) {
			if !submit {
				return
			}

			_, err := db.Exec("INSERT INTO representatives (name, active) VALUES (?, true)",
				nameEntry.Text)
			if err != nil {
				dialog.ShowError(err, window)
				return
			}

			dialog.ShowInformation("Success", "Representative added successfully", window)
		},
		window,
	)

	dialog.Show()
}

func showManageRepresentativesDialog(window fyne.Window, db *sql.DB) {
	representatives, err := internal.LoadRepresentatives(db)
	if err != nil {
		dialog.ShowError(err, window)
		return
	}

	list := widget.NewTable(
		func() (int, int) {
			return len(representatives), 1
		},
		func() fyne.CanvasObject {
			return container.NewHBox(
				widget.NewLabel("Template"),
				widget.NewButton("Deactivate", func() {}),
			)
		},
		func(id widget.TableCellID, cell fyne.CanvasObject) {
			box := cell.(*fyne.Container)
			label := box.Objects[0].(*widget.Label)
			deactivateBtn := box.Objects[1].(*widget.Button)

			rep := representatives[id.Row]
			label.SetText(rep.Name)

			deactivateBtn.OnTapped = func() {
				dialog.ShowConfirm("Deactivate Representative",
					"Are you sure you want to deactivate this representative?",
					func(confirm bool) {
						if confirm {
							_, err := db.Exec("UPDATE representatives SET active = false WHERE id = ?", rep.ID)
							if err != nil {
								dialog.ShowError(err, window)
								return
							}
							showManageRepresentativesDialog(window, db)
						}
					},
					window,
				)
			}
		},
	)

	list.SetColumnWidth(0, 400)

	content := container.NewVScroll(list)
	content.Resize(fyne.NewSize(500, 400))

	dialog := dialog.NewCustom("Manage Representatives", "Close", content, window)
	dialog.Resize(fyne.NewSize(500, 400))
	dialog.Show()
}

// shared/db/db.go
package db
import (
	"database/sql"
	"fmt"
	"os"
	"github.com/joho/godotenv"
	_ "github.com/tursodatabase/libsql-client-go/libsql"
)
func InitDB() (*sql.DB, error) {
	err := godotenv.Load(".env")
	if err != nil {
		return nil, fmt.Errorf("error loading .env file: %v", err)
	}
	primaryUrl := os.Getenv("TURSO_DATABASE_URL")
	if primaryUrl == "" {
		return nil, fmt.Errorf("TURSO_DATABASE_URL not set")
	}
	authToken := os.Getenv("TURSO_AUTH_TOKEN")
	if authToken == "" {
		return nil, fmt.Errorf("TURSO_AUTH_TOKEN not set")
	}
	db, err := sql.Open("libsql", primaryUrl+"?authToken="+authToken)
	if err != nil {
		return nil, fmt.Errorf("error connecting to database: %v", err)
	}
	// Create products table
	_, err = db.Exec(`
        CREATE TABLE IF NOT EXISTS products (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            price REAL NOT NULL,
            active BOOLEAN DEFAULT true
        )
    `)
	if err != nil {
		return nil, fmt.Errorf("error creating products table: %v", err)
	}
	_, err = db.Exec(`
    CREATE TABLE IF NOT EXISTS representatives (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        active BOOLEAN DEFAULT true
    )
`)
	if err != nil {
		return nil, fmt.Errorf("error creating representatives table: %v", err)
	}
	// Create orders table
	_, err = db.Exec(`
    CREATE TABLE IF NOT EXISTS orders (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        created_at DATETIME,
        client_name TEXT,
        contact TEXT,
        product_id INTEGER,
        quantity INTEGER,
        price REAL,
        needs_delivery BOOLEAN,
        delivery_address TEXT,
        comment TEXT,
        completed BOOLEAN,
        representative_id INTEGER,  -- Add the column first
        FOREIGN KEY(product_id) REFERENCES products(id),
        FOREIGN KEY(representative_id) REFERENCES representatives(id)
    )
`)
	if err != nil {
		return nil, fmt.Errorf("error creating orders table: %v", err)
	}
	return db, nil
}
